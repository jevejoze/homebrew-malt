name: follow naiveproxy

on:
  schedule:
    - cron: "23 3 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Fetch release and local version
        shell: bash
        run: |
          set -euo pipefail
          tag=$(curl -sL \
            -H "Authorization: Bearer ${{ github.token }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/klzgrad/naiveproxy/releases/latest | jq -r '.tag_name')
          echo "LAST_VERSION=${tag#v}" >> "$GITHUB_ENV"

          local=$(sed -n 's/^ *version \"\([^\"]*\)\".*/\1/p' Formula/naiveproxy.rb | head -n1)
          echo "LOCAL_VERSION=$local" >> "$GITHUB_ENV"

      - name: Check for updates
        shell: bash
        run: |
          set -euo pipefail
          if [ "$LAST_VERSION" = "$LOCAL_VERSION" ]; then
            echo "UPDATE=false" >> "$GITHUB_ENV"
          else
            echo "UPDATE=true" >> "$GITHUB_ENV"
          fi

      - name: Calculate sha256
        if: env.UPDATE == 'true'
        shell: bash
        run: |
          set -euo pipefail
          base="https://github.com/klzgrad/naiveproxy/releases/download/v${LAST_VERSION}"

          curl -sL "${base}/naiveproxy-v${LAST_VERSION}-mac-x64.tar.xz" -o /tmp/naiveproxy-mac-x64.tar.xz
          echo "X64_SHA256SUM=$(sha256sum /tmp/naiveproxy-mac-x64.tar.xz | awk '{print $1}')" >> "$GITHUB_ENV"

          curl -sL "${base}/naiveproxy-v${LAST_VERSION}-mac-arm64.tar.xz" -o /tmp/naiveproxy-mac-arm64.tar.xz
          echo "ARM64_SHA256SUM=$(sha256sum /tmp/naiveproxy-mac-arm64.tar.xz | awk '{print $1}')" >> "$GITHUB_ENV"

      - name: Update Formula
        if: env.UPDATE == 'true'
        shell: bash
        run: |
          set -euo pipefail
          cat > Formula/naiveproxy.rb <<EOF
          class Naiveproxy < Formula
            desc "Network proxy"
            homepage "https://github.com/klzgrad/naiveproxy"
            version "${LAST_VERSION}"
            if Hardware::CPU.intel?
              url "https://github.com/klzgrad/naiveproxy/releases/download/v#{version}/naiveproxy-v#{version}-mac-x64.tar.xz"
              sha256 "${X64_SHA256SUM}"
            else
              url "https://github.com/klzgrad/naiveproxy/releases/download/v#{version}/naiveproxy-v#{version}-mac-arm64.tar.xz"
              sha256 "${ARM64_SHA256SUM}"
            end
            license "BSD-3-Clause"

            def install
              bin.install "naive"
              pkgetc.install "config.json"
            end

            service do
              run [opt_bin/"naive", etc/"naiveproxy/config.json"]
              keep_alive true
              log_path var/"log/naiveproxy.log"
              error_log_path var/"log/naiveproxy.log"
            end
          end
          EOF

      - name: Commit and push
        if: env.UPDATE == 'true'
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add Formula/naiveproxy.rb
          git commit -m "update naiveproxy to ${LAST_VERSION}"
          git push
